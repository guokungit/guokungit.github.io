---
title: 基于OHIF实现影像协同
date: 2025-06-22 14:11:27
tags: 影像协同
categories: 项目
---

# <a href="https://github.com/OHIF/Viewers.git" >OHIF</a> 为开源项目，用于放射科医生查看CT、DR类影像所用的软件

## 项目目标
1、实现鼠标轨迹协同
2、多人协同操作（兼容不同协同人的显示器分辨率不同）
3、进度同步（兼容中途加入协同时，可以跟上协同进度）

## 前端设计

### 接口通信
1、restful实现dicom协议的影像数据传输
2、websocket实现指令协同

#### websocket通道
1、鼠标轨迹同步指令通道
2、协同指令通道
3、进度同步通道

### 加载影像方法
1、通过url获取影像号
2、通过websocket获取影像号进行加载

### 鼠标轨迹同步
1、监听当前用户的鼠标的move事件，记录下当前鼠标的横、纵坐标
2、将横、纵坐标通过鼠标轨迹同步通道传输给后端，由后端对当前鼠标轨迹进行广播
3、通过鼠标轨迹同步通道获取到当前鼠标id，在当前页面上创建鼠标的svg
4、通过变更鼠标svg的颜色和标签进行区分不同用户
5、通过鼠标轨迹同步通道获取的横、纵坐标同步到当前svg上，实现鼠标轨迹同步展现
6、通过将svg定义为绝对定位实现，全屏幕的移动

### 多人协同
由于OHIF通过lerna管控当前子服务，通过将conterstonejs插件加载到本地，通过lerna管控实现变更插件代码实现事件控制
1、OHIF中服务加载事件的指令执行中监听操作中的参数，通过多人协同通道广播给房间内的其他用户
2、其他用户在多人协同通道中监听到该指令时，已经指令类别执行不同的操作
3、其他用户需要在本地搭建一个消费者执行队列，当上一个指令执行完毕后，再从消费队列中取出下一个指令进行执行
4、指令开始和结束的事件通过conterstonejs封装的服务中获取。

### 进度同步
当协同开始后，后加入影像协同时，通过获取当前状态进行同步当前的影像操作痕迹
1、当用户刚加入影像协同时，通过进度同步通道获取当前的影像号
2、用户通过进度同步通道获取到影像号后加载影像
3、加载完影像后，进度同步通道获取到消息后，发送当前影像协同的进度
4、用户通过进度同步通道获取当前的影像进度，区分当前页面和其他未激活的状态，进行渲染

### <a href="https://github.com/guokungit/heartWebsocket.git">websocket的心跳检测</a>
websocket通道，每隔1分钟进行ping、pong机制实现通道连接状态判断。当断开后，进行10次重连。10次后仍未连接上连接中断


## 后端设计




